# FlatWiki Audit (2026-02-24)

## Zusammenfassung

Dieses Audit fokussierte AuthN/AuthZ, Upload-/Dateifluss, CSRF, Pfadsicherheit, Fehlerpfade und Robustheit.

Gefundene Hauptrisiken:
- **Hoch:** Upload-ACL-Bypass für verknüpfte, aber unverschlüsselte Dateien bei aktivem Public-Read-Modus.
- **Mittel:** Upload-Sicherheitsmetadaten wurden in mehreren Flows entfernt statt konsistent fortgeschrieben.
- **Mittel (offen):** Multipart-Admin-POSTs validieren CSRF erst nach Stream-Verarbeitung (I/O vor AuthZ-Entscheidung).
- **Niedrig (offen):** Session-TTL wird während normaler Nutzung nicht verlängert.

Umgesetzte Fixes:
- Zugriff auf `/uploads/*` prüft bei vorhandener Datei-Metadatenbindung (slug) die Seitenberechtigung immer, nicht nur bei `encrypted=true`.
- Upload-Metadaten werden bei unverschlüsselten Uploads und beim Entschlüsseln fortgeschrieben (statt gelöscht).
- Tests für die neue Upload-Access-Policy ergänzt.

Offen geblieben:
- Bestandsdateien ohne Upload-Sicherheitsmetadaten haben weiterhin nur die globale Upload-Gate-Policy.
- CSRF-vor-I/O-Härtung für große Multipart-Admin-Endpunkte steht noch aus.
- Session-Sliding-Expiration ist nicht implementiert.

## Verifizierte Checkliste

- [x] Entry-Points inventarisiert (Routes, Hooks, Uploads, Storage, Crypto, Admin-Actions)
- [x] AuthN/AuthZ-Flows geprüft (Login/Session/Admin/Public-Read)
- [x] Upload-Pfad, Dateitypvalidierung, Pfadnormalisierung geprüft
- [x] Wiki-Storage/Integrität (atomic writes, HMAC) geprüft
- [x] Backup/Restore Dateipfade und Ticket-Flows geprüft
- [x] CSRF-Abdeckung aller mutierenden Routen geprüft
- [x] Hochrisiko-Fix umgesetzt + Tests ergänzt
- [ ] Vollständiger Testlauf (`npm test`) im aktuellen Environment nicht möglich (kein Node/npm vorhanden)

## Deployment-Hinweise

- Deploy nur mit vorhandenem `CONTENT_ENCRYPTION_KEY`, `CONTENT_INTEGRITY_KEY`, `COOKIE_SECRET`.
- Nach Deploy Upload-Zugriffspfad aktiv verifizieren:
  - Gastzugriff auf öffentliches Upload (ohne Scoped-Metadaten) je nach Public-Read-Mode.
  - Gastzugriff auf Upload mit Scoped-Metadaten einer restriktiven Seite muss `401` liefern.
  - Angemeldeter, aber unberechtigter User muss `403` erhalten.
- Empfehlung: einmaliger Metadaten-Backfill für bestehende Uploads ohne `upload-security.json`-Eintrag.

## Rollback-Hinweise

- Rollback über Git-Revision der geänderten Dateien:
  - `src/index.ts`
  - `src/lib/uploadAccessPolicy.ts`
  - `src/routes/wikiRoutes.ts`
  - `tests/upload-security.test.ts`
- Bei Rollback wird vorheriges Verhalten wiederhergestellt (Public-Read kann verknüpfte unverschlüsselte Uploads wieder global freigeben).
